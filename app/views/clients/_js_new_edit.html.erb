<script type="text/javascript">
    //Copy & Paste de endereços
    $('.copy' ).button({icons: {primary: "ui-icon-copy"       }, text: false });
    $('.paste').button({icons: {primary: "ui-icon-clipboard"  }, text: false });
    $('.map'  ).button({icons: {primary: "ui-icon-pin-s"      }, text: false });
    $('.cep'  ).button({icons: {primary: "ui-icon-mail-closed"}, text: false });

    $('a.copy').click(function(){
      $('.copyied').removeClass('copyied');
      $(this).parent().addClass('copyied');
      return false;
    });

    $('a.paste').click(function(){
      fieldsFrom = $('.copyied').parent();
      fieldsTo   = $(this).parent().parent();

      fieldsTo.find( 'input[name$=street\]]'      ).attr('value', fieldsFrom.find( 'input[name$=street\]]'      ).attr('value'));
      fieldsTo.find( 'input[name$=number\]]'      ).attr('value', fieldsFrom.find( 'input[name$=number\]]'      ).attr('value'));
      fieldsTo.find( 'input[name$=complement\]]'  ).attr('value', fieldsFrom.find( 'input[name$=complement\]]'  ).attr('value'));
      fieldsTo.find( 'input[name$=neighborhood\]]').attr('value', fieldsFrom.find( 'input[name$=neighborhood\]]').attr('value'));
      fieldsTo.find( 'input[name$=city\]]'        ).attr('value', fieldsFrom.find( 'input[name$=city\]]'        ).attr('value'));
      fieldsTo.find('select[name$=estate_id\]]'   ).attr('value', fieldsFrom.find('select[name$=estate_id\]]'   ).attr('value'));
      fieldsTo.find( 'input[name$=country\]]'     ).attr('value', fieldsFrom.find( 'input[name$=country\]]'     ).attr('value'));
      fieldsTo.find( 'input[name$=cep\]]'         ).attr('value', fieldsFrom.find( 'input[name$=cep\]]'         ).attr('value'));
      return false;
    });

    $('.map').click(function(){
      context = $(this).parent().parent();
      stt = context.find( 'input[name$=street\]]'                   ).attr('value');
      nbr = context.find( 'input[name$=number\]]'                   ).attr('value');
      nbh = context.find( 'input[name$=neighborhood\]]'             ).attr('value');
      cty = context.find( 'input[name$=city\]]'                     ).attr('value');
      cep = context.find( 'input[name$=cep\]]'                      ).attr('value');
      ett = context.find('select[name$=estate_id\]] option:selected').text();

      address = escape(stt + ', ' + nbr + ' - ' + nbh + ', ' + cty + ' - ' + ett + ', ' + cep);
      $(this).attr('href', 'http://maps.google.com.br?q=' + address);
    });

    //Consulta CEP
    $('.cep').click(function(){

      context = $(this).parent().parent();
      cep     = context.find('input[name$=cep\]]').attr('value');

      if (cep == "" || cep.length <= 4)
      {
        alert('CEP inválido');
      }
      else
      {
        $.ajax({
          url: '/cep/findCep',
          data: 'cep=' + cep,
          type: 'GET',
          dataType: 'json',
          success: function(data){

            result = eval(data);

            context.find( 'input[name$=street\]]'      ).attr('value', result.logradouro);
            context.find( 'input[name$=neighborhood\]]').attr('value', result.bairro);
            context.find( 'input[name$=city\]]'        ).attr('value', result.cidade);
            context.find('select[name$=estate_id\]]'   ).attr('value', result.estate_id);
            context.find( 'input[name$=country\]]'     ).attr('value', 'Brasil');
            context.find( 'input[name$=number\]]'      ).focus();
          }
        });
      }
    });

    //marca contato principal
    function markMainPhone() {
      $('span.main').removeClass('main').text('Telefone');

      target = $('input[type=hidden][name*=main][value=1]');
      target.prev().find('.title').addClass('main').text('Telefone (Principal)');

      //client_contacts_attributes_1_phones_attributes_0_main
      $('.main-phone').removeClass('main-phone');
      id = target.attr('id').slice(0,28);
      $('input[id^='+id+'][type!=hidden], select[id^='+id+']').each(function(){
        $(this).parent().parent().addClass('main-phone');
      });
    }

    $('.mask-phone').prev().click(function(){
      id = $(this).next().attr('id').replace('number', 'main');
      $('input[type=hidden][name*=main][value=1]').attr('value', '0');
      $('#' + id                                 ).attr('value', '1');

      markMainPhone();
    });

    //prevent phone[main] = null
    $('input[type=hidden]').each(function(){
      if ($(this).attr('value') == "") {
        $(this).attr('value', '0')
      }
    });

    markMainPhone();
</script>

<style type="text/css">
.main-phone {
  font-weight: bold;
  color: #00f;
}
</style>

